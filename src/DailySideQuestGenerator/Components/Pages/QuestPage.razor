@using DailySideQuestGenerator.Models
@using DailySideQuestGenerator.Services.Interfaces
@inject ICategoryService CategoryService
@inject IQuestService QuestService

<h3>Filter by Category</h3>

@if (categories == null)
{
    <p>Loading...</p>
}
else
{
    <div class="category-filter">
        @foreach (var cat in categories)
        {
            <label style="margin-right: 15px;">
                <input type="checkbox"
                       value="@cat.Name"
                       @bind="cat.Selected" />
                <span style="font-weight: bold; color:@cat.Color;">
                    @cat.Name
                </span>
            </label>
        }

        <button class="btn btn-primary" @onclick="ApplyFilter">
            Apply
        </button>
    </div>
}

<hr />

@code {
    private List<CategoryVm>? categories;
    private List<DailyQuest>? todays;

    protected override async Task OnInitializedAsync()
    {
        var cats = await CategoryService.GetCategoriesAsync();
        var enabled = await CategoryService.GetEnabledCategoriesAsync();

        categories = cats
            .Select(c => new CategoryVm
            {
                Name = c.Name,
                Color = c.Color,
                Selected = enabled.Contains(c.Name)
            })
            .ToList();

        todays = (await QuestService.GetTodaysQuestsAsync()).ToList();
    }

    private async Task ApplyFilter()
    {
        var selected = categories!
            .Where(c => c.Selected)
            .Select(c => c.Name)
            .ToList();

        await CategoryService.SetEnabledCategoriesAsync(selected);

        // regenerate today's quests
        todays = (await QuestService.GetTodaysQuestsAsync()).ToList();
    }

    class CategoryVm
    {
        public string Name { get; set; } = "";
        public string Color { get; set; } = "";
        public bool Selected { get; set; }
        public string Id => Name;
    }
}
